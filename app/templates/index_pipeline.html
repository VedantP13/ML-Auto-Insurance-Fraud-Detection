<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto Insurance Fraud Detector</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .step {
      display: none;
    }

    .step.active {
      display: block;
    }
  </style>
</head>

  <body class="bg-gray-100 text-gray-800">
    <div class="max-w-4xl mx-auto py-10">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h1 class="text-3xl font-bold mb-2">Auto Insurance Fraud Detector</h1>
          <p class="text-gray-600">Fill in the details to analyze the claim.</p>
        </div>
        <a href="/dashboard" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">View Analytics</a>
      </div>
      

    <!-- Progress bar -->
    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
      <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full w-1/3"></div>
    </div>

          <!-- Multi-step form -->
      <form method="POST" action="/predict" class="bg-white p-6 rounded-xl shadow" id="fraudForm">
  
        <!-- Step 1: Policy & Claimant -->
        <div class="step active" id="step-1">
          <h2 class="text-xl font-semibold mb-4 text-gray-800">Policy & Claimant Information</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group">
              <label for="age" class="block text-sm font-medium text-gray-700 mb-1">Age *</label>
              <input type="number" name="age" id="age" placeholder="e.g., 35" min="16" max="100" required 
                     class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <small class="text-gray-500 text-xs">Enter age between 16-100</small>
            </div>
            
            <div class="form-group">
              <label for="policy_state" class="block text-sm font-medium text-gray-700 mb-1">Policy State *</label>
              <select name="policy_state" id="policy_state" required 
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Select State</option>
                {% for v in choices.policy_state %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
              </select>
            </div>
            
            <div class="form-group">
              <label for="policy_csl" class="block text-sm font-medium text-gray-700 mb-1">Policy CSL *</label>
              <select name="policy_csl" id="policy_csl" required 
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Select Coverage</option>
                {% for v in choices.policy_csl %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
              </select>
            </div>
            
            <div class="form-group">
              <label for="policy_deductable" class="block text-sm font-medium text-gray-700 mb-1">Policy Deductible *</label>
              <input type="number" name="policy_deductable" id="policy_deductable" placeholder="e.g., 500" min="0" step="100" required 
                     class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <small class="text-gray-500 text-xs">Enter deductible amount in USD</small>
            </div>
            
            <div class="form-group">
              <label for="policy_annual_premium" class="block text-sm font-medium text-gray-700 mb-1">Annual Premium *</label>
              <input type="number" name="policy_annual_premium" id="policy_annual_premium" placeholder="e.g., 1200" min="0" step="50" required 
                     class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <small class="text-gray-500 text-xs">Enter annual premium in USD</small>
            </div>
            
            <div class="form-group">
              <label for="insured_sex" class="block text-sm font-medium text-gray-700 mb-1">Gender *</label>
              <select name="insured_sex" id="insured_sex" required 
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Select Gender</option>
                {% for v in choices.insured_sex %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
              </select>
            </div>
            
            <div class="form-group">
              <label for="insured_education_level" class="block text-sm font-medium text-gray-700 mb-1">Education Level</label>
              <select name="insured_education_level" id="insured_education_level" 
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Select Education</option>
                {% for v in choices.insured_education_level %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
              </select>
            </div>
            
            <div class="form-group">
              <label for="insured_occupation" class="block text-sm font-medium text-gray-700 mb-1">Occupation</label>
              <select name="insured_occupation" id="insured_occupation" 
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Select Occupation</option>
                {% for v in choices.insured_occupation %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
              </select>
            </div>
            
            <div class="form-group">
              <label for="insured_relationship" class="block text-sm font-medium text-gray-700 mb-1">Relationship</label>
              <select name="insured_relationship" id="insured_relationship" 
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Select Relationship</option>
                {% for v in choices.insured_relationship %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
              </select>
            </div>
            
            <div class="form-group">
              <label for="policy_bind_date" class="block text-sm font-medium text-gray-700 mb-1">Policy Start Date *</label>
              <input type="date" name="policy_bind_date" id="policy_bind_date" required 
                     class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <small class="text-gray-500 text-xs">Select when the policy started</small>
            </div>
          </div>
        </div>

      <!-- Step 2: Incident -->
      <div class="step" id="step-2">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Incident Details</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group">
            <label for="incident_type" class="block text-sm font-medium text-gray-700 mb-1">Incident Type *</label>
            <select name="incident_type" id="incident_type" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">Select Incident Type</option>
              {% for v in choices.incident_type %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="incident_severity" class="block text-sm font-medium text-gray-700 mb-1">Incident Severity *</label>
            <select name="incident_severity" id="incident_severity" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">Select Severity</option>
              {% for v in choices.incident_severity %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="authorities_contacted" class="block text-sm font-medium text-gray-700 mb-1">Authorities Contacted</label>
            <select name="authorities_contacted" id="authorities_contacted" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">Select Option</option>
              {% for v in choices.authorities_contacted %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="incident_city" class="block text-sm font-medium text-gray-700 mb-1">Incident City *</label>
            <select name="incident_city" id="incident_city" required
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">Select City</option>
              {% for v in choices.incident_city %}
                <option value="{{ v }}">{{ v }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="incident_hour_of_the_day" class="block text-sm font-medium text-gray-700 mb-1">Incident Hour (0-23) *</label>
            <input type="number" name="incident_hour_of_the_day" id="incident_hour_of_the_day" min="0" max="23" required placeholder="e.g., 14" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div class="form-group">
            <label for="witnesses" class="block text-sm font-medium text-gray-700 mb-1">Number of Witnesses</label>
            <input type="number" name="witnesses" id="witnesses" min="0" placeholder="e.g., 0" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div class="form-group">
            <label for="police_report_available" class="block text-sm font-medium text-gray-700 mb-1">Police Report Available *</label>
            <select name="police_report_available" id="police_report_available" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">Select Option</option>
              {% for v in choices.police_report_available %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="incident_date" class="block text-sm font-medium text-gray-700 mb-1">Incident Date *</label>
            <input type="date" name="incident_date" id="incident_date" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
        </div>
      </div>

      <!-- Step 3: Claim & Vehicle -->
      <div class="step" id="step-3">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Claim & Vehicle Info</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-group">
            <label for="total_claim_amount" class="block text-sm font-medium text-gray-700 mb-1">Total Claim Amount *</label>
            <input type="number" name="total_claim_amount" id="total_claim_amount" min="0" step="1" required placeholder="e.g., 5000" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div class="form-group">
            <label for="injury_claim" class="block text-sm font-medium text-gray-700 mb-1">Injury Claim</label>
            <input type="number" name="injury_claim" id="injury_claim" min="0" step="1" placeholder="e.g., 0" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div class="form-group">
            <label for="property_claim" class="block text-sm font-medium text-gray-700 mb-1">Property Claim</label>
            <input type="number" name="property_claim" id="property_claim" min="0" step="1" placeholder="e.g., 0" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div class="form-group">
            <label for="vehicle_claim" class="block text-sm font-medium text-gray-700 mb-1">Vehicle Claim</label>
            <input type="number" name="vehicle_claim" id="vehicle_claim" min="0" step="1" placeholder="e.g., 0" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div class="form-group">
            <label for="auto_make" class="block text-sm font-medium text-gray-700 mb-1">Auto Make *</label>
            <select name="auto_make" id="auto_make" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">Select Make</option>
              {% for v in choices.auto_make %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="auto_year" class="block text-sm font-medium text-gray-700 mb-1">Auto Year *</label>
            <input type="number" name="auto_year" id="auto_year" min="1980" max="2025" required placeholder="e.g., 2015" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
        </div>
      </div>

      <!-- Navigation buttons -->
      <div class="flex justify-between mt-6">
        <button type="button" id="prevBtn" class="px-4 py-2 bg-gray-300 rounded">Previous</button>
        <button type="button" id="nextBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Next</button>
        <button type="submit" id="submitBtn" class="hidden px-4 py-2 bg-green-600 text-white rounded">Analyze
          Claim</button>
      </div>
    </form>

    <!-- Result -->
    {% if result %}
    <div class="mt-10 space-y-6">

      <!-- Main Result Card -->
      <div class="backdrop-blur-lg bg-white/70 rounded-2xl shadow-xl p-6">
        <h2 class="text-xl font-semibold mb-4">Prediction Result</h2>
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between">

          <!-- Left: Labels -->
          <div>
            <p class="mb-2 text-lg">Prediction:
              <span class="font-bold">{{ result.label }}</span>
            </p>
            <p class="mb-2 text-lg">Risk Band:
              <span class="px-3 py-1 rounded-full text-white font-medium
            {% if result.risk == 'Low' %}bg-green-500
            {% elif result.risk == 'Medium' %}bg-yellow-500
            {% else %}bg-red-500{% endif %}">
                {{ result.risk }}
              </span>
            </p>
            <p class="mb-2 text-lg">Fraud Probability: <span class="font-semibold">{{ (result.prob*100) | round(1)
                }}%</span></p>
          </div>

          <!-- Right: Chart -->
          <div class="w-48 h-48">
            <canvas id="probChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Summary Card -->
      <div class="backdrop-blur-lg bg-white/70 rounded-2xl shadow-xl p-6">
        <h2 class="text-lg font-semibold mb-3">Claim Summary</h2>
        <ul class="text-sm text-gray-700 space-y-1">
          <li><span class="font-medium">Claim Amount:</span> {{ result.payload.total_claim_amount }}</li>
          <li><span class="font-medium">Incident Date:</span> {{ result.payload.incident_date_year }}-{{
            result.payload.incident_date_month }}</li>
          <li><span class="font-medium">Policy Bind Date:</span> {{ result.payload.policy_bind_date_year }}-{{
            result.payload.policy_bind_date_month }}</li>
          <li><span class="font-medium">Auto:</span> {{ result.payload.auto_make }} {{ result.payload.auto_model }} ({{
            result.payload.auto_year }})</li>
        </ul>
      </div>

      <!-- Explanation / Feature Importance -->
      <div class="backdrop-blur-lg bg-white/70 rounded-2xl shadow-xl p-6">
        <h2 class="text-lg font-semibold mb-3">Why this prediction?</h2>
        <p class="text-sm text-gray-600 mb-4">These are the top factors that influenced the model’s decision:</p>
        <canvas id="featChart"></canvas>
      </div>

    </div>

    <!-- Charts -->
    <script>
      // Probability Chart
      var ctx = document.getElementById('probChart').getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Fraudulent', 'Not Fraudulent'],
          datasets: [{
            data: [{{ (result.prob * 100) | round(1) }}, {{ 100-(result.prob * 100) | round(1) }}],
        backgroundColor: ['#e74c3c', '#2ecc71']
      }]
    },
        options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } }
      }
  });

      // Feature Importance Chart (using real model data only)
      var featCanvas = document.getElementById('featChart');
      var ctx2 = featCanvas.getContext('2d');
      {% if result and result.feature_importance %}
      var featureNames = [
        {% for feature, importance in result.feature_importance %}
          "{{ feature }}",
        {% endfor %}
      ];
      var importanceScores = [
        {% for feature, importance in result.feature_importance %}
          {{ importance }},
        {% endfor %}
      ];
      {% else %}
      var featureNames = [];
      var importanceScores = [];
      {% endif %}

      if (featureNames.length > 0) {
        new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: featureNames,
            datasets: [{
              label: 'Feature Importance Score',
              data: importanceScores,
              backgroundColor: '#3498db',
              borderColor: '#2980b9',
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            scales: { 
              x: { 
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Importance Score'
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Features'
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return 'Importance: ' + context.parsed.x.toFixed(3);
                  }
                }
              }
            }
          }
        });
      } else {
        featCanvas.outerHTML = '<p class="text-sm text-gray-500">No explanation available for the provided inputs.</p>';
      }
    </script>
    {% endif %}

  </div>

  <!-- Step Navigation Script -->
  <script>
    let currentStep = 1;
    const steps = document.querySelectorAll(".step");
    const progress = document.getElementById("progress-bar");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");

    function showStep(n) {
      steps.forEach((s, i) => s.classList.toggle("active", i === n - 1));
      progress.style.width = (n / steps.length) * 100 + "%";
      prevBtn.style.display = (n === 1) ? "none" : "inline-block";
      nextBtn.style.display = (n === steps.length) ? "none" : "inline-block";
      submitBtn.style.display = (n === steps.length) ? "inline-block" : "none";
    }

    prevBtn.addEventListener("click", () => { if (currentStep > 1) showStep(--currentStep); });
    nextBtn.addEventListener("click", () => {
      if (currentStep < steps.length) {
        const current = document.getElementById(`step-${currentStep}`);
        const requiredFields = current.querySelectorAll('input[required], select[required], textarea[required]');
        for (const field of requiredFields) {
          if (!field.checkValidity()) {
            field.reportValidity();
            return;
          }
        }
        showStep(++currentStep);
      }
    });
    showStep(currentStep);
  </script>
  
  
</body>

</html>